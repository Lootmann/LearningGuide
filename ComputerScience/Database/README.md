# Database

Terms and something.

## Schema

データベースの構造を表現する設計書
データベースは強調したい属性や、見方によって様々な分割の方法がある
で、その分割方法の有名なやつに「三層スキーマ」がある

- 外部スキーマ(概念スキーマ)

  - ユーザから見た DB 画面の入力 UI やデータなど

- 概念スキーマ(論理スキーマ)

  - 開発者から見た DB DB に保持するデータの要素、データ同士の Relation を記述する

- 内部スキーマ(物理スキーマ)

  - 概念スキーマで定義された倫理データモデルをどのように DBMS 内部に格納するかを定義する

それぞれのスキーマの独立性（密な関係にならないように）を保障するために
考え出されたもの、それがスキーマであり、三層はその方法の一つ
NoSQL だったり、Graph だったり、取り扱うデータによって DB は様々あるので
そこではまた別の方法論があるとか無いとか

## Relation

別々のテーブルを関連付けること、またはその関連性のこと よくわからん

- table: Fruit

| id  | name   | price |
| --- | ------ | ----- |
| 1   | apple  | 100   |
| 2   | banana | 200   |
| 3   | orange | 250   |

- table: Buying

| id  | date       | num | fruit_id |
| --- | ---------- | --- | -------- |
| 1   | 2022-03-26 | 2   | 1        |
| 2   | 2022-03-26 | 2   | 3        |
| 3   | 2022-03-26 | 1   | 2        |

`buying` テーブルの `fruit_id` は `Fruit`テーブルの `id` を示しており
`Buying.fruit_id` と `Fruit.id` が一致しているとこを見ると果物の名前がわかる
まさに別々のテーブルが関連付けられている

この関係を Relation があると呼ぶ つまり関係性があるね
`Buying.fruit_id` の列がなければ Relation は無い つまり関係性がない

## Lookup

リレーションで関連付けたテーブルのデータをコピーする機能

## Sharding

DB の分割手法の一つ
データを複数のノードのディスクに分割配置することで
DB へのリクエストを分散し全体のスループとを上げる目的で利用される

基本的に各ノードは独立してデータを保持しているので、各ノードが毎に
自分が担当するデータに対してクエリを実行すればよい

以下の分割方法は `range` という種類のもの
他にもシャードの分け方はたくさんあるらしい

```
app ---> [Node A] ----------> [DB]
   \      user(1 - 1000)
    \
     ---> [Node B] ---------> [DB]
      \    user(1001- 2000)
       \
        \
         ---> ...
```


# ER Model

## DB Normalization

Relation から データの冗長性を排除すること

```
NFNF: 非正規形
BCNF: ボイスコッド正規形

NFNF -> 1NF -> 2NF -> 3NF -> BCNF -> 4NF -> 5NF
```

**Normal Form: 正規形**
正規化とは リレーションからデータの冗長性を排除していく一連のプロレス

**1NF**
全ての属性が Atomicであること


### テーブルの分解

```
| 学籍番号 | 氏名 | 部活ID | 登録日 |

学籍番号 -> 氏名
{学籍番号, 部活ID} -> 登録日 # 部分関数従属性
```

```
# 分解

# Table 1
学籍番号 -> 氏名

# Table 2
{学籍番号, 部活ID} -> 登録日
```


**2NF**
1NF かつ 全ての非キー属性がキーに完全関数従属していること

`X -> Y`: Xの値が決まれば Yの値が1つに定まる
`{A, B} -> C`: Cの値は AとBの値の組み合わせで1つに定まる


**3NF**
2NF かつ 全ての非キー属性が キーに推移関数従属していないこと

```
| id | name | lab_id | lab_name |


# lab_id -> lab_name: 推移関数従属

| id | name | lab_id |
| lab_id | lab_name |
```


**BCNF**
3NF かつ 関数従属性が すべて取り除かれた状態

```
| id | department | lab_name |

# 分解

| id         | department |
| department | lab_name   |
```

適当な分解をすると `情報の欠落` が発生してしまうこと

| id | department | lab_name |
| -- | ---------- | -------- |
| s1 | DB         | RDB      |
| s1 | Lang       | go-lang  |
| s2 | DB         | NoSQL    |

| id | department |
| -- | ---------- |
| s1 | DB         |
| s1 | Lang       |
| s2 | DB         |

| department | lab_name |
| ---------- | -------- |
| DB         | RDB      |
| Lang       | go-lang  |
| DB         | NoSQL    |


id -> lab_name: の情報が欠落してるので
s1 -> DB, DB -> {RDB, NoSQL} と、一意に特定ができない

いつの間にか何かの情報が欠落している

